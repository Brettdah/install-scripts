server {
    listen 80 ;

    server_name git.charles-sanquer.net;
    #rewrite ^ $scheme://git.charles-sanquer.net$request_uri permanent;
    rewrite ^ https://git.charles-sanquer.net$request_uri permanent;
}

# HTTPS server
#
server {
    listen 443;
    server_name git.charles-sanquer.net;

    root /usr/share/gitweb;

    ssl on;
    ssl_certificate /etc/ssl/localcerts/git.charles-sanquer.net.pem;
    ssl_certificate_key /etc/ssl/localcerts/git.charles-sanquer.net.key;

    ssl_session_timeout 5m;

    ssl_protocols SSLv3 TLSv1;
    ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
    ssl_prefer_server_ciphers on;

    access_log /var/log/nginx/gitweb.access.log;
    error_log /var/log/nginx/gitweb.error.log;
    charset utf-8;
    
    auth_basic           "RESTRICTED ACCESS";
    auth_basic_user_file /home/git/git_users.passwd;
 
    # static repo files for cloning over https
    #location ~ ^.*\.git/objects/([0-9a-f]+/[0-9a-f]+|pack/pack-[0-9a-f]+.(pack|idx)) {
    #    root /home/git/repositories/;
    #}
 
    # requests that need to go to git-http-backend
    #location ~ ^.*\.git/(HEAD|info/refs|objects/info/.*|git-(upload|receive)-pack)$ {
    #    root /home/git/repositories;
    #
    #    fastcgi_pass unix:/var/run/fcgiwrap.socket;
    #    fastcgi_param SCRIPT_FILENAME   /usr/lib/git-core/git-http-backend;
    #    fastcgi_param PATH_INFO         $uri;
    #    fastcgi_param GIT_PROJECT_ROOT  /home/git/repositories;
    #    fastcgi_param GIT_HTTP_EXPORT_ALL "";
    #    fastcgi_param REMOTE_USER $remote_user;
    #    include fastcgi_params;
    #}
 
    # send anything else to gitweb if it's not a real file
    try_files $uri @gitweb;
    location @gitweb {
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
        fastcgi_param SCRIPT_FILENAME   /usr/share/gitweb/gitweb.cgi;
        fastcgi_param PATH_INFO         $uri;
        fastcgi_param GITWEB_CONFIG     /etc/gitweb.conf;
        include fastcgi_params;
   }

}
